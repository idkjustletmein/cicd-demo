name: CI/CD Pipeline



on:

 push:

   branches: \[ main, develop ]

 pull_request:

   branches: \[ main ]



env:

 PYTHON\_VERSION: '3.9'



jobs:

 test:

   name: Unit Testing

   runs-on: ubuntu-latest

   

   steps:

   - name: Checkout code

     uses: actions/checkout@v3

   

   - name: Set up Python

     uses: actions/setup-python@v4

     with:

       python-version: ${{ env.PYTHON_VERSION }}

   

   - name: Cache dependencies

     uses: actions/cache@v3

     with:

       path: ~/.cache/pip

       key: ${{ runner.os }}-pip-${{ hashFiles('\*\*/requirements.txt') }}

       restore-keys: |

         ${{ runner.os }}-pip-

   

   - name: Install dependencies

     run: |

       python -m pip install --upgrade pip

       pip install -r requirements.txt

   

   - name: Run tests with coverage

     run: |

       pytest --cov=app --cov-report=xml --cov-report=html --cov-report=term

   

   - name: Upload coverage reports

     uses: actions/upload-artifact@v3

     with:

       name: coverage-report

       path: htmlcov/

   

   - name: Display test summary

     run: |

       echo "‚úÖ All tests passed successfully!"



 code-quality:

   name: Code Quality Analysis

   runs-on: ubuntu-latest

   needs: test

   

   steps:

   - name: Checkout code

     uses: actions/checkout@v3

     with:

       fetch-depth: 0  # Full history for better analysis

   

   - name: SonarQube Scan

     uses: SonarSource/sonarqube-scan-action@master

     env:

       SONAR\_TOKEN: ${{ secrets.SONAR_TOKEN }}

       SONAR\_HOST\_URL: ${{ secrets.SONAR_HOST_URL }}

   

   - name: SonarQube Quality Gate

     uses: SonarSource/sonarqube-quality-gate-action@master

     timeout-minutes: 5

     env:

       SONAR\_TOKEN: ${{ secrets.SONAR_TOKEN }}

     continue-on-error: true



 build:

   name: Build Docker Image

   runs-on: ubuntu-latest

   needs: [test, code-quality]

   

   steps:

   - name: Checkout code

     uses: actions/checkout@v3

   

   - name: Set up Docker Buildx

     uses: docker/setup-buildx-action@v2

   

   - name: Log in to Heroku Container Registry

     env:

       HEROKU\_API\_KEY: ${{ secrets.HEROKU_API_KEY }}

     run: |

       echo $HEROKU\_API\_KEY | docker login --username=\_ --password-stdin registry.heroku.com

   

   - name: Build and push Docker image

     env:

       HEROKU\_APP\_NAME: ${{ secrets.HEROKU_APP_NAME }}

     run: |

       docker build -t registry.heroku.com/$HEROKU\_APP\_NAME/web .

       docker push registry.heroku.com/$HEROKU\_APP\_NAME/web

   

   - name: Display build info

     run: |

       echo "üê≥ Docker image built successfully!"

       echo "Image: registry.heroku.com/${{ secrets.HEROKU_APP_NAME }}/web"



 deploy:

   name: Deploy to Heroku

   runs-on: ubuntu-latest

   needs: build

   if: github.ref == 'refs/heads/main'

   

   steps:

   - name: Checkout code

     uses: actions/checkout@v3

   

   - name: Deploy to Heroku

     env:

       HEROKU\_API\_KEY: ${{ secrets.HEROKU_API_KEY }}

       HEROKU\_APP\_NAME: ${{ secrets.HEROKU_APP_NAME }}

     run: |

       heroku container:release web --app $HEROKU\_APP\_NAME

   

   - name: Verify deployment

     env:

       HEROKU\_APP\_NAME: ${{ secrets.HEROKU_APP_NAME }}

     run: |

       curl -f https://$HEROKU\_APP\_NAME.herokuapp.com/health || exit 1

       echo "‚úÖ Deployment verified successfully!"



 notify:

   name: Send Notifications

   runs-on: ubuntu-latest

   needs: [test, code-quality, build, deploy]

   if: always()

   

   steps:

   - name: Send Discord notification (Success)

     if: ${{ success() }}

     env:

       DISCORD\_WEBHOOK: ${{ secrets.DISCORD\_WEBHOOK }}

     run: |

       curl -H "Content-Type: application/json" \\

         -X POST \\

         -d '{

           "username": "CI/CD Bot",

           "avatar\_url": "https://github.githubassets.com/images/modules/logos\_page/GitHub-Mark.png",

           "embeds": \[{

             "title": "‚úÖ Pipeline Succeeded",

             "description": "All stages completed successfully!",

             "color": 3066993,

             "fields": \[

               {"name": "Repository", "value": "${{ github.repository }}", "inline": true},

               {"name": "Branch", "value": "${{ github.ref\_name }}", "inline": true},

               {"name": "Commit", "value": "`${{ github.sha }}`", "inline": false},

               {"name": "Author", "value": "${{ github.actor }}", "inline": true},

               {"name": "Workflow", "value": "${{ github.workflow }}", "inline": true}

             ],

             "timestamp": "${{ github.event.head\_commit.timestamp }}"

           }]

         }' \\

         $DISCORD\_WEBHOOK

   

   - name: Send Discord notification (Failure)

     if: ${{ failure() }}

     env:

       DISCORD\_WEBHOOK: ${{ secrets.DISCORD\_WEBHOOK }}

     run: |

       curl -H "Content-Type: application/json" \\

         -X POST \\

         -d '{

           "username": "CI/CD Bot",

           "avatar\_url": "https://github.githubassets.com/images/modules/logos\_page/GitHub-Mark.png",

           "embeds": \[{

             "title": "‚ùå Pipeline Failed",

             "description": "One or more stages failed. Check the logs for details.",

             "color": 15158332,

             "fields": \[

               {"name": "Repository", "value": "${{ github.repository }}", "inline": true},

               {"name": "Branch", "value": "${{ github.ref\_name }}", "inline": true},

               {"name": "Commit", "value": "`${{ github.sha }}`", "inline": false},

               {"name": "Author", "value": "${{ github.actor }}", "inline": true},

               {"name": "Run URL", "value": "\[View Logs](${{ github.server\_url }}/${{ github.repository }}/actions/runs/${{ github.run\_id }})", "inline": false}

             ],

             "timestamp": "${{ github.event.head\_commit.timestamp }}"

           }]

         }' \\

         $DISCORD\_WEBHOOK

